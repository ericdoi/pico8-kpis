pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

-- constants
px=20 -- x-position
py=64 -- y-position
pstate=0 -- current player state
pspr=0 --currentsprite
pdir=0 --currentdirection 
pat=0 -- player state timer
maxdx=2 -- max x absolute velocity
maxdy=4 -- max y absolute velocity

map_src_x=0 -- start x for level map 
map_src_y=0 -- start y for level map
map_w=16 -- level width in tiles
map_h=12 -- level height in tiles
panel_clr=11
kpi_clr={8, 7, 11} -- bad, neutral, good colors

-- map flags
flag_solid=0

function _init()
 music(0)
end

function _update()
 b0=btn(0) -- button0 state
 b1=btn(1) -- button1 state 
 b2=btn(2) -- button2 state
 pat+=1 -- increment state clock
 move_player()
end

function kpi_x() return px/8 end
function kpi_y() return map_h-py/8 end

function test_kpi(kpi)
 val = kpi.fn()
 if ((kpi.fail_lo != nil and val < kpi.fail_lo) or (kpi.fail_hi != nil and val > kpi.fail_hi)) return 1 --if failed
 if (val >= kpi.goal_lo and val <= kpi.goal_hi) return 3 -- else if succeeded
 return 2
end

kpi_pos = { {x=4, y=map_h*8+4}, {x=4, y=map_h*8+12} }

-- kpis are defined with a function, a goal range, and optional fail boundaries.
-- 1=fail, 2=neutral, 3=success
-- cont=true means the kpi is continuous
lvl1 = {
 kpis = {
  { fn=kpi_x, cont=true, goal_lo=15, goal_hi=16, fail_lo=nil, fail_hi=nil },
  { fn=kpi_y, cont=true, goal_lo=6, goal_hi=7, fail_lo=nil, fail_hi=nil }
 }
}
cur_lvl = lvl1

function _draw()
 cls()
 -- draw goal panel
 rect(0,map_h*8+1,127,127,panel_clr)
 draw_kpis(cur_lvl)
 -- draw the world
 map(map_src_x,map_src_y,0,0,map_w,map_h)
 -- draw the player, we use dir to mirror sprites
 spr(pspr,px,py,1,1,pdir==-1)
 
  -- debug
 print("px="..px.." mapx="..flr((px+4)/8).." | py="..py.." mapy="..flr((py+4)/8), 10, 10, 15)
end

function draw_kpis(lvl)
 for i=1,#lvl.kpis do
  kpi=lvl.kpis[i]
  result=test_kpi(kpi)
  val=kpi.fn()
  if (kpi.cont) val=flr(val*10)/10 -- round to tenth if continuous
  print(val, kpi_pos[i].x, kpi_pos[i].y, kpi_clr[result])
  print(":", kpi_pos[i].x+16, kpi_pos[i].y, kpi_clr[2])
  print(kpi.goal_lo.."-"..kpi.goal_hi, kpi_pos[i].x+20, kpi_pos[i].y, kpi_clr[3])
 end
end

function move_player_x()
 if (b0) pdir=-1
 if (b1) pdir=1
 if (b0 or b1) and not( solid(flr((px+4+pdir*4.1)/8), flr((py+4)/8)) ) then
  px += pdir*maxdx
 end
 px = max(min(px,120), 0) -- wall bounds
end

function move_player()
 move_player_x()
 
 -- idle state
 if pstate==0 then
  pspr=1
  if (b0 or b1) change_state(1)
  if (b2) change_state(3)
  if (canfall()) change_state(2)
 end
 
 -- walk state
 if pstate==1 then
  pspr=flr(pat/2)%2+1
  
  if (not (b0 or b1)) change_state(0)
  if (b2) change_state(3)
  if (canfall()) change_state(2)
 end

 -- fall state
 if pstate==2 then
  pspr=3
  if (canfall()) then
   py+=min(maxdy,pat) -- move the player
   if (not canfall()) py=flr(py/8)*8 -- check ground contact
   else
    py=flr(py/8)*8 -- fix position when we hit ground
    change_state(0)
  end
 end

 -- jump state
 if pstate==3 then
  pspr=2
  py-=4-pat
  if (not b2 or pat>5 ) change_state(0)
 end
end

-- test if a point is solid
function solid(mapx, mapy)
 return fget(mget(mapx, mapy), flag_solid)
end

function canfall()
 -- get the map tile under the player
 return not solid(flr((px+4)/8), flr((py+8)/8))
end

function change_state(s)
 pstate=s
 pat=0
end



__gfx__
0000000000000000000000000000000000555500000000d0000000d000555500005000000000000066666665666666656666666566666665666666656666666d
000000000566666005666660056666600066660006666ddd06666ddd00666650056666000066660065555550655555506555555065555550655555506dddddd1
00700700056366300563663005636630066666600666ddd00666ddd006666665566666655666666565bbbb5065aaaa50659999506588885065dddd506dddddd1
000770000566666005666660056666600666dddd0666dd600666dd600666dddd5666dddd5666dddd65bbbb5065aaaa50659999506588885065dddd506dddddd1
000770000005600000056000000560000666dddd06666660066666600666dddd5666dddd5666dddd65bbbb5065aaaa50659999506588885065dddd506dddddd1
0070070000065559000655590006555906666660066666600666666056666660566666655666666565bbbb5065aaaa50659999506588885065dddd506dddddd1
0000000005066000000660500006600000666600066666600666666005666600006666500066660065555550655555506555555065555550655555506dddddd1
000000000050050000500500005050000055550000000000000000000055550000000500000000005000000050000000500000005000000050000000d1111111
bbbbbbbb77777775000000000000000000000000000000000000000000000000000000000000000076dddd1076dddd1076dddd1076dddd1076dddd10bbbbbbbb
0000000075555550000000000000000006666660066666d00000000000000000000000000000000076dddd1076dddd1076dddd1076dddd1076dddd10bb00000b
b0b0b0b0755bb55000000000000000000616616006166ddd0000000000000000000000000000000076d00d1076d00d1076d00d1076d00d1076dbbd10b0bbbbb0
0000000075bbbb500000000000000000066666600666ddd00000000000000000000000007a9999a776d00d1076d00d1076d00d1076d99d1076dbbd10b0b000b0
0b0b0b0b75bbbb5000000000000000000006dddd0006dd000000000000000000000000007a9999a776d00d1076d00d1076d99d1076d99d1076dbbd10b0b000b0
00000000755bb55000000000000000000006dddd000660000000000000000000000000000000000076d00d1076d99d1076d99d1076d99d1076dbbd10b0b000b0
b0b0b0b075555550000000000000000005066000050660000000000000000000000000000000000076dddd1076dddd1076dddd1076dddd1076dddd10b0bbbbb0
0000000050000000000000000000000000500500005005000000000000000000000000000000000076dddd1076dddd1076dddd1076dddd1076dddd10bb00000b
00000000000000000000000000000000000000000000000000000000000000000000000000000000010101010000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000010101010000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000009a7777a9000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000009a7777a9010101010000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000010101010000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06666660066666600666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06166160061661600616616000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06666660066666600666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00066000000660000006600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00066600000666000006660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05066000000660500056605000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00500500005005000500050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000001010101010101010100000000000000010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002a0000000000002a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000002a2a2a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2a2a2a2a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2a2a2a2a000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000002a2a0000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000f0f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000f000000000000000f0f0f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000212121212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606060606060606060606060606000000000021212121210021212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606060606060606060606060606000000000000212121212100002100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000006212100000000002121212121212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000006212100002121002100000021210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000006212121210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000a00001f05022050270501f0001a00018000127001a000200001b0001070019000107000c0001470007700087000e000297001c000057001c000067003600008700197001c000360001a000360001700016000
0014000010155001050010500105101550010500105001051015500105001050010510155131550010500105101550010500105001051015500105001050010510155001050010500105101550e1550010500105
011400001015500105001050010510155001050010500105101550010500105001051015513155001050010510155001000010000105101551010010155101551715200105151520010513152001051015200105
005000001c552000001f552000002155200000235521a0001800000000000000000000000180001a0001f0001d000000000000000000000001c0001c000180001a00000000000000000000000000000000000000
015000001c552000001a5520000018552000001a55200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800002205027020270001f0001a00018000127001a000200001b0001070019000107000c0001470007700087000e000297001c000057001c000067003600008700197001c000360001a000360001700016000
0008000025050240301f0001f0001a00018000120001a000200001b0001000019000100000c0001400007000080000e000290001c000050001c000060003600008000190001c000360001a000360001700016000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0128000024052210521c0521a052230521f0521a0521805200000000000000000000180001a0001f0001d000000000000000000000001c0001c000180001a0000000000000000000000000000000000000000000
0128000024052210521c0521a052230521f0521a0521805200000000000000000000180001a0001f0001d000000000000000000000001c0001c000180001a0000000000000000000000000000000000000000000
0128000024052210521c0521a052230521f0521a0521805200000000000000000000180001a0001f0001d000000000000000000000001c0001c000180001a0000000000000000000000000000000000000000000
0128000024052210521c0521a052230521f0521a0521805200000000000000000000180001a0001f0001d000000000000000000000001c0001c000180001a0000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
00 01430000
02 02440000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000
00 00000000

